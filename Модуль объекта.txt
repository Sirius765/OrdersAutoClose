
Функция ЗаполнитьТаблицуЗаказов(сПараметры) Экспорт
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ЗаказыПокупателейОстатки.ЗаказПокупателя КАК ЗаказПокупателя,
	|	ЗаказыПокупателейОстатки.ДоговорКонтрагента.Владелец КАК Контрагент,
	|	РАЗНОСТЬДАТ(ЗаказыПокупателейОстатки.ЗаказПокупателя.Дата, &ТекущаяДата, ДЕНЬ) КАК КолВоДней,
	|	ВЫБОР
	|		КОГДА РАЗНОСТЬДАТ(ЗаказыПокупателейОстатки.ЗаказПокупателя.Дата, &ТекущаяДата, ДЕНЬ) < &ДнейДоЗакрытия
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК Предупредить,
	|	ВЫБОР
	|		КОГДА РАЗНОСТЬДАТ(ЗаказыПокупателейОстатки.ЗаказПокупателя.Дата, &ТекущаяДата, ДЕНЬ) >= &ДнейДоЗакрытия
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК Закрыть,
	|	ЗаказыПокупателейОстатки.ЗаказПокупателя.Ответственный КАК Ответственный,
	|	ЗаказыПокупателейОстатки.ДоговорКонтрагента.Владелец.ОсновнойМенеджерПокупателя КАК ОсновнойМенеджерПокупателя,
	|	ИСТИНА КАК Обработать,
	|	НАЧАЛОПЕРИОДА(ДОБАВИТЬКДАТЕ(ЗаказыПокупателейОстатки.ЗаказПокупателя.Дата, ДЕНЬ, &ДнейДоЗакрытия), ДЕНЬ) КАК ДатаПланируемогоАвтозакрытияЗаказа
	|ИЗ
	|	РегистрНакопления.ЗаказыПокупателей.Остатки(
	|			,
	|			ЗаказПокупателя.Дата > &ДатаНачала
	|				И РАЗНОСТЬДАТ(ЗаказПокупателя.Дата, &ТекущаяДата, ДЕНЬ) > &ДнейДоЗакрытия - &ДнейПредупрежденияПередЗакрытием) КАК ЗаказыПокупателейОстатки
	|
	|УПОРЯДОЧИТЬ ПО
	|	ЗаказПокупателя
	|АВТОУПОРЯДОЧИВАНИЕ";

	Запрос.УстановитьПараметр("ДатаНачала",НачалоДня(сПараметры.ДатаНачала));         
	Запрос.УстановитьПараметр("ДнейПредупрежденияПередЗакрытием",Справочники.дм_КонстантыМегатрейд.КоличествоДнейПредупрежденияПередАвтозакрытиемЗаказовПокупателей.Значение);
	Запрос.УстановитьПараметр("ДнейДоЗакрытия",Справочники.дм_КонстантыМегатрейд.КоличествоДнейОжиданияАвтозакрытияЗаказовПокупателей.Значение);
	Запрос.УстановитьПараметр("ТекущаяДата",КонецДня(сПараметры.ТекущаяДата));
	Результат = Запрос.Выполнить().Выгрузить();
	Возврат Результат;
	
КонецФункции

//Функция ОбновитьЗадачу(стзЗаказ,сПолучатель,сТипДействия) Экспорт
Процедура ОбновитьЗадачу(стзЗаказ,сПолучатель) Экспорт
	Если НЕ стзЗаказ.Закрыть И НЕ стзЗаказ.Предупредить Тогда Возврат;	КонецЕсли;
	
	лИсполнитель = стзЗаказ[сПолучатель];
	Если НЕ ЗначениеЗаполнено(лИсполнитель) Тогда
		лИсполнитель = Справочники.Пользователи.НайтиПоНаименованию("Савченко Надежда Евгеньевна");
	КонецЕсли;
	
	Запрос=Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ЗадачиПользователя.Ссылка КАК Задача
	|ИЗ
	|	Задача.ЗадачиПользователя КАК ЗадачиПользователя
	|ГДЕ
	|	НЕ ЗадачиПользователя.ПометкаУдаления
	|	И ЗадачиПользователя.Объект = &Заказ
	|	И ЗадачиПользователя.Исполнитель = &Исполнитель";
	Запрос.УстановитьПараметр("Заказ", стзЗаказ.ЗаказПокупателя); 
	Запрос.УстановитьПараметр("Исполнитель", лИсполнитель);
	Рез = Запрос.Выполнить().Выгрузить();
	
	Если Рез.Количество() > 0 Тогда
		зо = Рез[0].Задача.ПолучитьОбъект();
	Иначе
		зо = Задачи.ЗадачиПользователя.СоздатьЗадачу();
		
		//Если лИсполнитель = Справочники.Пользователи.НайтиПоНаименованию("Иванова Екатерина Анатольевна") Тогда
		//	лИсполнитель = Справочники.Пользователи.НайтиПоНаименованию("Программист");
		//КонецЕсли;
		зо.Исполнитель  = лИсполнитель;
		зо.Объект		= стзЗаказ.ЗаказПокупателя;
	КонецЕсли;
	
	
	//Если ЗначениеЗаполнено(стзЗаказ["Задача_"+сПолучатель]) = Истина Тогда
	//	зо = стзЗаказ["Задача_"+сПолучатель].получитьОбъект();
	//Иначе
	//	зо = Задачи.ЗадачиПользователя.СоздатьЗадачу();
	//	//++МС 06.12.2017 Отладка
	//	//зо.Исполнитель  = стзЗаказ[сПолучатель];
	//	лИсполнитель = стзЗаказ[сПолучатель];
	//	Если лИсполнитель = Справочники.Пользователи.НайтиПоНаименованию("Иванова Екатерина Анатольевна") Тогда
	//		лИсполнитель = Справочники.Пользователи.НайтиПоНаименованию("Программист");
	//	КонецЕсли;
	//	зо.Исполнитель  = лИсполнитель;
	//	//--МС 06.12.2017 Отладка
	//	зо.Объект		= стзЗаказ.ЗаказПокупателя;
	//КонецЕсли;
	зо.Дата				= НачалоДня(ТекущаяДата());
	зо.СрокИсполнения 	= КонецДня(ТекущаяДата());
	//++МС 18.12.2017
	//Если Лев(стзЗаказ.Действие,7)="Закрыть" Тогда
	//	Если сТипДействия = "Закрытие" Тогда
	//		зо.Описание			= "Автоматически закрыт заказ:"+СокрЛП(стзЗаказ.Контрагент)+", "+СокрЛП(стзЗаказ.ЗаказПокупателя);
	//	Иначе	
	//		зо.Описание			= Формат(стзЗаказ.ДатаПланируемогоАвтозакрытияЗаказа,"ДФ=dd.MM.yyyy")+" - дата планируемого автозакрытия заказа: "+СокрЛП(стзЗаказ.Контрагент)+", "+СокрЛП(стзЗаказ.ЗаказПокупателя);
	//	КонецЕсли;
	//Иначе	
	//	зо.Описание			= "Напоминание о незакрытом заказе: "+СокрЛП(стзЗаказ.Контрагент)+", "+СокрЛП(стзЗаказ.ЗаказПокупателя);
	//КонецЕсли;
	Если стзЗаказ.Закрыть Тогда
		зо.Описание			= "Автоматически закрыт заказ:"+СокрЛП(стзЗаказ.Контрагент)+", "+СокрЛП(стзЗаказ.ЗаказПокупателя);
	ИначеЕсли стзЗаказ.Предупредить Тогда
		зо.Описание			= Формат(стзЗаказ.ДатаПланируемогоАвтозакрытияЗаказа,"ДФ=dd.MM.yyyy")+" - дата планируемого автозакрытия заказа: "+СокрЛП(стзЗаказ.Контрагент)+", "+СокрЛП(стзЗаказ.ЗаказПокупателя);
	КонецЕсли;
	//--МС 18.12.2017
	зо.Наименование		= СокрЛП(зо.Описание);
	зо.Инициатор		= ПараметрыСеанса.ТекущийПользователь;
	зо.Оповещение		= Истина;
	зо.СрокОповещения	= НачалоДня(ТекущаяДата());
	зо.ПамятнаяДата     = Ложь;
	зо.ДатаИсполнения	= КонецДня(ТекущаяДата());
	//зо.СотрудникКлиент	= Перечисления.ВидЗадачи.Сотрудник;
	зо.Контрагент		= стзЗаказ.Контрагент;
	зо.ПометкаУдаления	= Ложь;
	зо.Выполнена		= Ложь;
	зо.Записать();
	//Возврат зо.Ссылка;
КонецПроцедуры

Функция ПредупредитьПользователей(тпЗаказы) Экспорт
	
	ЗаписьЖурналаРегистрации("Фоновое задание. Автозакрытие заказов: предупредить пользователей", УровеньЖурналаРегистрации.Информация, Метаданные.РегламентныеЗадания.ЗакрытиеЗаказовПокупателей, "АвтоЗакрытиеЗаказовПокупателей", "Старт предупреждения пользователей");
	
	колСтрок = 0;
	Для Каждого стзЗаказ Из тпЗаказы Цикл
		
		Если стзЗаказ.Предупредить = Истина Тогда
			НачатьТранзакцию();
			//стзЗаказ.Задача_Ответственный 				= ОбновитьЗадачу(стзЗаказ,"Ответственный");	
			ОбновитьЗадачу(стзЗаказ,"Ответственный");	
			Если стзЗаказ.Ответственный <> стзЗаказ.ОсновнойМенеджерПокупателя Тогда
				//стзЗаказ.Задача_ОсновнойМенеджерПокупателя 	= ОбновитьЗадачу(стзЗаказ,"ОсновнойМенеджерПокупателя");
				ОбновитьЗадачу(стзЗаказ,"ОсновнойМенеджерПокупателя");
			КонецЕсли;
			колСтрок = колСтрок + 1;
			ЗафиксироватьТранзакцию();
		КонецЕсли;
		
	КонецЦикла;
	
	ЗаписьЖурналаРегистрации("Фоновое задание. Автозакрытие заказов: предупредить пользователей", УровеньЖурналаРегистрации.Информация, Метаданные.РегламентныеЗадания.ЗакрытиеЗаказовПокупателей, "АвтоЗакрытиеЗаказовПокупателей", "Окончание предупреждения пользователей");
	
	Возврат колСтрок;
	
КонецФункции

//параметры:
//ЗаказПокупателя, Ответственный, Задача_Ответственный,ОсновнойМенеджерПокупателя,Задача_ОсновнойМенеджерПокупателя
Процедура ЗакрытьОдинЗаказПокупателя(сПараметры) Экспорт

	Если сПараметры.Свойство("ЗаказПокупателя") = Истина Тогда
		ЗаказПокупателя = сПараметры.ЗаказПокупателя;
	Иначе
		Возврат;
	КонецЕсли;
	Если ЗначениеЗаполнено(ЗаказПокупателя) = Ложь Тогда
		Возврат;
	КонецЕсли;
	
	
	// ++МС 26.10.2017 Поставить статус "Отменен" - если реализации по заказу не было
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	РеализацияТоваровУслуг.Ссылка
	|ИЗ
	|	Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
	|ГДЕ
	|	РеализацияТоваровУслуг.Сделка = &Сделка
	|	И РеализацияТоваровУслуг.Проведен";
	Запрос.УстановитьПараметр("Сделка", ЗаказПокупателя.ссылка);
	Рез = Запрос.Выполнить();
	Если Рез.Пустой() Тогда
		Если ЗаказПокупателя.СтатусЗаказа <> Перечисления.СтатусыЗаказа.Отменен Тогда
			ЗаказОб = ЗаказПокупателя.ПолучитьОбъект();
			ЗаказОб.СтатусЗаказа = Перечисления.СтатусыЗаказа.Отменен;
			Попытка
				ЗаказОб.Записать();
				//Сообщить("Статус заказа: """ + ЗаказПокупателя + """ изменен со статуса """ + лСтарыйСтатус + """ на """ + ЗаказОб.СтатусЗаказа + """");
			Исключение
				Сообщить(ОписаниеОшибки());
			КонецПопытки;	
		КонецЕсли;
		Возврат;	// Отмененный заказ в закрытии не нуждается
	Иначе
		Если ЗаказПокупателя.СтатусЗаказа <> Перечисления.СтатусыЗаказа.Отгружено Тогда
			ЗаказОб = ЗаказПокупателя.ПолучитьОбъект();
			ЗаказОб.СтатусЗаказа = Перечисления.СтатусыЗаказа.Отгружено;
			Попытка
				ЗаказОб.Записать();
				//Сообщить("Статус заказа: """ + ЗаказПокупателя + """ изменен со статуса """ + лСтарыйСтатус + """ на """ + ЗаказОб.СтатусЗаказа + """");
			Исключение
				Сообщить(ОписаниеОшибки());
			КонецПопытки;
		КонецЕсли;
	КонецЕсли;
	// ++МС 26.10.2017 Поставить статус "Отменен" - если реализации по заказу не было
	
	
	до = Документы.ЗакрытиеЗаказовПокупателей.СоздатьДокумент();
	до.дата 			= ТекущаяДата();
	до.Подразделение 	= ЗаказПокупателя.Подразделение;
	до.Ответственный	= ПараметрыСеанса.ТекущийПользователь;
	до.ВидОперации		= Перечисления.ВидыОперацийЗакрытиеЗаказовПокупателей.ЗакрытиеЗаказов;
	//до.СпособЗаполнения	= 
	до.Комментарий		= "#Заказ закрыт автоматически";
	
	тч = до.Заказы;
	стч = тч.Добавить();
	стч.ЗаказПокупателя			= ЗаказПокупателя.ссылка;
	стч.ПричинаЗакрытияЗаказа	= Справочники.ПричиныЗакрытияЗаказов.НайтиПоКоду("УТ0000001");
	
	Попытка
		до.Записать(РежимЗаписиДокумента.Запись);
		до.Записать(РежимЗаписиДокумента.Проведение);
		Сообщить("Создано: "+СокрЛП(до.Ссылка));
	Исключение
		Сообщить("Ошибка создания документа ""Закрытие заказа покупателей"" для заказа """ + ЗаказПокупателя.ссылка + """: " + ОписаниеОшибки());
	КонецПопытки;
	
КонецПроцедуры

Функция ЗакрытьИУведомить(тпЗаказы) Экспорт
	
	ЗаписьЖурналаРегистрации("Фоновое задание. Автозакрытие заказов: закрыть заказы", УровеньЖурналаРегистрации.Информация, Метаданные.РегламентныеЗадания.ЗакрытиеЗаказовПокупателей, "АвтоЗакрытиеЗаказовПокупателей", "Старт закрытия заказов");
	
	колСтрок = 0;
	Для Каждого стзЗаказ Из тпЗаказы Цикл
		Если стзЗаказ.Закрыть = Истина Тогда
			
			НачатьТранзакцию();
			
			//закрываем	
			сПараметры = Новый Структура;
			сПараметры.Вставить("ЗаказПокупателя",стзЗаказ.ЗаказПокупателя);
			ЗакрытьОдинЗаказПокупателя(сПараметры);
			
			//информируем если прошло не более 5 дней
			Если (стзЗаказ.ДатаПланируемогоАвтозакрытияЗаказа + 5*60*60*24) >= ТекущаяДата() Тогда
				//стзЗаказ.Задача_Ответственный 				= ОбновитьЗадачу(стзЗаказ,"Ответственный");
				ОбновитьЗадачу(стзЗаказ,"Ответственный");
				Если стзЗаказ.Ответственный <> стзЗаказ.ОсновнойМенеджерПокупателя Тогда
					//стзЗаказ.Задача_ОсновнойМенеджерПокупателя 	= ОбновитьЗадачу(стзЗаказ,"ОсновнойМенеджерПокупателя");
					ОбновитьЗадачу(стзЗаказ,"ОсновнойМенеджерПокупателя");
				КонецЕсли;
			КонецЕсли;
			колСтрок = колСтрок + 1;
			
			ЗафиксироватьТранзакцию();
			
		КонецЕсли;	
		
	КонецЦикла;
	
	ЗаписьЖурналаРегистрации("Фоновое задание. Автозакрытие заказов: закрыть заказы", УровеньЖурналаРегистрации.Информация, Метаданные.РегламентныеЗадания.ЗакрытиеЗаказовПокупателей, "АвтоЗакрытиеЗаказовПокупателей", "Окончание закрытия заказов");
	
	Возврат КолСтрок;
	
КонецФункции

// ++МС 08.10.2017 МТ0039 Автозакрытие заказов поставщиков
#region ЗакрытиеЗаказовПоставщикам

Процедура ЗакрытьЗаказыПоставщикам(сПараметры) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ЗаказыПоставщикамОстатки.Номенклатура,
	|	ЗаказыПоставщикамОстатки.ЗаказПоставщику КАК ЗаказПоставщику,
	|	ЗаказыПоставщикамОстатки.ДоговорКонтрагента.Владелец КАК Контрагент,
	|	РАЗНОСТЬДАТ(ЗаказыПоставщикамОстатки.ЗаказПоставщику.Дата, &ТекущаяДата, ДЕНЬ) КАК КолВоДней
	|ИЗ
	|	РегистрНакопления.ЗаказыПоставщикам.Остатки(
	|			,
	|			ЗаказПоставщику.Дата > &ДатаНачала
	|				И РАЗНОСТЬДАТ(ЗаказПоставщику.Дата, &ТекущаяДата, ДЕНЬ) > ВЫБОР
	|					КОГДА ДоговорКонтрагента.Владелец.МС_КоличествоДнейДоставкиТовараПоставщиком <> 0
	|						ТОГДА ДоговорКонтрагента.Владелец.МС_КоличествоДнейДоставкиТовараПоставщиком
	|					ИНАЧЕ &КоличествоДнейОжидания
	|				КОНЕЦ) КАК ЗаказыПоставщикамОстатки
	|ГДЕ
	|	ЗаказыПоставщикамОстатки.КоличествоОстаток > 0
	|
	|УПОРЯДОЧИТЬ ПО
	|	ЗаказПоставщику
	|АВТОУПОРЯДОЧИВАНИЕ";
	Запрос.УстановитьПараметр("ДатаНачала",НачалоДня(сПараметры.ДатаНачала));         
	Запрос.УстановитьПараметр("ТекущаяДата", НачалоДня(ТекущаяДата()));
	Запрос.УстановитьПараметр("КоличествоДнейОжидания",сПараметры.КоличествоДнейОжидания);
	
	тпЗаказы = Запрос.Выполнить().Выгрузить();
	тпЗаказы.Свернуть("ЗаказПоставщику,Контрагент,КолВоДней");
	
	ЗаписьЖурналаРегистрации("Фоновое задание. Автозакрытие заказов: закрыть заказы поставщикам", УровеньЖурналаРегистрации.Информация, Метаданные.РегламентныеЗадания.ЗакрытиеЗаказовПокупателей, "АвтоЗакрытиеЗаказовПокупателей", "Старт закрытия заказов поставщикам");
	
	колСтрок = 0;
	Для Каждого стзЗаказ Из тпЗаказы Цикл
		
		НачатьТранзакцию();
		
		//закрываем	
		сПараметры = Новый Структура;
		сПараметры.Вставить("ЗаказПоставщику",стзЗаказ.ЗаказПоставщику);
		ЗакрытьОдинЗаказПоставщику(сПараметры);
		
		//информируем	
		//стзЗаказ.Задача_Ответственный 				= ОбновитьЗадачу(стзЗаказ,"Ответственный","Закрытие");
		//стзЗаказ.Задача_ОсновнойМенеджерПокупателя 	= ОбновитьЗадачу(стзЗаказ,"ОсновнойМенеджерПокупателя","Закрытие");
		//колСтрок = колСтрок + 1;
		
		ЗафиксироватьТранзакцию();
	КонецЦикла;
	
	ЗаписьЖурналаРегистрации("Фоновое задание. Автозакрытие заказов: закрыть заказы поставщикам", УровеньЖурналаРегистрации.Информация, Метаданные.РегламентныеЗадания.ЗакрытиеЗаказовПокупателей, "АвтоЗакрытиеЗаказовПокупателей", "Окончание закрытия заказов поставщикам");
	
	//Возврат КолСтрок;
	
КонецПроцедуры

Процедура ЗакрытьОдинЗаказПоставщику(сПараметры) Экспорт

	Если сПараметры.Свойство("ЗаказПоставщику") Тогда
		ЗаказПоставщику = сПараметры.ЗаказПоставщику;
	Иначе
		Возврат;
	КонецЕсли;
	Если НЕ ЗначениеЗаполнено(ЗаказПоставщику) Тогда
		Возврат;
	КонецЕсли;
	
	до = Документы.ЗакрытиеЗаказовПоставщикам.СоздатьДокумент();
	до.дата 			= ТекущаяДата();
	до.Подразделение 	= ЗаказПоставщику.Подразделение;
	до.Ответственный	= ПараметрыСеанса.ТекущийПользователь;
	до.Комментарий		= "#Заказ закрыт автоматически";
	
	тч = до.Заказы;
	стч = тч.Добавить();
	стч.ЗаказПоставщику			= ЗаказПоставщику.ссылка;
	стч.ПричинаЗакрытияЗаказа	= Справочники.ПричиныЗакрытияЗаказов.НайтиПоКоду("УТ0000001");
	
	Попытка
		до.Записать(РежимЗаписиДокумента.Запись);
		до.Записать(РежимЗаписиДокумента.Проведение);
		Сообщить("Создано: "+СокрЛП(до.Ссылка));
	Исключение
		Сообщить("Ошибка создания документа ""Закрытие заказа поставщикам"" для заказа """ + ЗаказПоставщику.ссылка + """: " + ОписаниеОшибки());
	КонецПопытки;
	
КонецПроцедуры

#endregion 
// --МС 08.10.2017 МТ0039 Автозакрытие заказов поставщиков